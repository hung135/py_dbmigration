#This file is to configure mapping of files to database tables 
# {{{value}}}  Anything in triple bracket denotes runtime variables to be populated
# {{value}}  Anything in double bracket denotes variables reference any up the yaml tree
- path: '/workspace/tests/sample_data/'
  mp_cores: 2
  write_path: '/workspace/tmp/'
  convert_table_name_snake_case: True
  enabled: True # activates this configration tree
  project_name: test_1
  reprocess: True # flag used to identify files we want to attempt to re-run the next go around
  extract_file_name_data: '\d\d\d\d\d\d'  # regext to extract data from file name and store
  format_extracted_date: 'YYYYMM'       #postgres format of the regex above
  process_logic: # this will get executed for all files
    - logic: 'custom_logic.load_status'
    - logic: 'custom_logic.generate_checksum'
    - logic: 'custom_logic.log_file_size'
    - logic: 
        plugin: '/workspace/tests/plugin_logic/plugin_logic_sample.py'
    - logic: 'custom_logic.abort_if_duplicate'
  #post_process_logic: #logic to be ran after everything else regarless of exceptions to above
  #  - logic: 'custom_logic.load_status_post_import'
  mapping: #lis of logic to run for each specify file type that matches the file_regex below
    #look for zip files and extract them
    - file_regex: '^.*.zip$'
      file_type: 'zip'
      process_logic:
        - logic: 'custom_logic.abort_if_obsolete'
        - logic: 'custom_logic.extract_compressed_file'
    - file_regex: '^.*.mdb$'
      file_type: 'mdb'
      process_logic:
        #- logic: 'custom_logic.abort_if_obsolete'
        - logic: 'custom_logic.count_file_linux_wc'
        - logic: 'custom_logic.extract_msaccess_csv'
    # - file_regex: '^.*.gz$'
    #   file_type: 'gzip'
    #   process_logic:
    #     #- logic: 'custom_logic.abort_if_obsolete'
    #     - logic: 'custom_logic.extract_compressed_file'
    
    #################################################################################################################################################################
    #look for data files and import them
    #Files from Master table is full re-load so we want to delete everything and load whatever is in this
    - file_regex: '.*.csv$'
      file_type: 'CSV'
      schema_name: 'test'
      reprocess: True
      #table_name: test
      file_delimiter: ","
      process_logic:
        - logic: 'custom_logic.count_file_linux_wc'
        
        - logic: 
            name: 'custom_logic.pandas_import'
            save_previous_row_count: True
      file_encoding: 'ISO-8859-1'
      post_action: 
        - sql: "vacuum analyze {{schema_name}}.{{table_name}}"
    - file_regex: '.*.xlsx$'
      file_type: 'XLS'
      schema_name: 'test'
      reprocess: True
      #table_name: 'testxls'
      file_delimiter: ","
      process_logic:
        - logic: 
            name: 'custom_logic.pandas_import_excel'
            count_table_name_regex: '\.(.*)\d'
      file_encoding: 'ISO-8859-1'
      post_action: 
        - sql: "vacuum analyze {{schema_name}}.{{table_name}}"
        - sql: "select 1 from logging.meta_source_files where id={{{file_id}}}"